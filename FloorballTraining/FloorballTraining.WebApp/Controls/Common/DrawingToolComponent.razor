@using Microsoft.AspNetCore.Components
@using MudBlazor.Utilities

@inject IJSRuntime JsRuntime

<MudPaper Elevation="0" Class="ma-0 pa-0">

    <MudPaper Elevation="0">
        <MudButton OnClick="LoadJson">Load</MudButton>
        <MudTextField @bind-Value="DrawingAsJson"></MudTextField>
    </MudPaper>

    <MudPaper Elevation="0" Class="d-inline-block gap-2">
        <MudIconButton Color="Color.Success" Title="Uložit" Size="Size.Large"  Variant="Variant.Outlined" Icon="@Icons.Material.Sharp.Save" OnClick="SaveAsJson" />
        <MudIconButton Color="Color.Success" Title="Uložit na disk" Size="Size.Large"  Icon="@Icons.Material.Sharp.Download" OnClick="Download" />
        <MudIconButton id="newdrawing" Color="Color.Secondary" Title="Nový" Size="Size.Large" Icon="@Icons.Material.Sharp.Create" OnClick="NewDrawing" />
    </MudPaper>

    @*Fields*@
    <MudPaper Elevation="0" Class="d-inline-flex align-content-start justify-content-start">
        @foreach (var field in Assets.Fields)
        {
            <MudButton OnClick="@(()=>SetField(field.Value))">
                <MudImage ObjectFit="ObjectFit.Fill" Width="64" Height="64" Src="@field.Value" Elevation="0" Class="rounded" />
            </MudButton>
        }
    </MudPaper>

    @*Drawings*@
    <MudPaper Elevation="0" Class="d-inline-flex align-content-start justify-content-start gap-4">
        @foreach (var drawing in Assets.Drawings)
        {
            <MudButton OnClick="@(()=>SetTool(drawing.Key))" Style="@(_tool==drawing.Key? "background-color:#ffb31f;": "")">
                <MudImage ObjectFit="ObjectFit.Fill" Width="64" Height="64" Src="@drawing.Value" Elevation="0" Class="rounded"  />
            </MudButton>
        }
    </MudPaper>

    @*Tools*@
    <MudPaper Elevation="0" Class="d-inline-flex align-content-start justify-content-start gap-4">
        <MudColorPicker id="colorpicker" Style=@($" width:140px;color: {_colorValue};") ColorPickerView="ColorPickerView.Palette" Label="Barva" @bind-value="@_colorValue" />
        <MudIconButton id="@Assets.ToolDelete" Icon="@Icons.Material.Sharp.Delete" Color="Color.Info" OnClick="@(DeleteSelectedShapes)">Smazat</MudIconButton>

    </MudPaper>
    <MudPaper id="container" Class="ma-0 pa-0 d-block" Style="width: 100%; height: 80vh;"></MudPaper>
</MudPaper>

@code {
    [Parameter]
    public string DrawingAsJson { get; set; } = string.Empty;

    [Parameter]
    public EventCallback<string> OnDrawingChanged { get; set; }
    
    private string _tool = string.Empty;

    private MudColor _colorValue = null!;
    
    private IJSObjectReference Konva { get; set; } = null!;
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Konva = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./DrawingTool.js");
            await Konva.InvokeVoidAsync("init", "container", null, null); // "container" je ID divu pro umístění plátna Konva.js

            if (!string.IsNullOrEmpty(DrawingAsJson))
            {
                await Konva.InvokeVoidAsync("loadDrawing", DrawingAsJson);
            }

        }
    }
    
    private async Task SetTool(string toolId)
    {
        _tool = _tool == toolId ? string.Empty : toolId;


        await Konva.InvokeVoidAsync("setTool", _tool);
    }

    private async Task Download()
    {
        await Konva.InvokeVoidAsync("saveDrawing");
    }

    private async Task SaveAsJson()
    {
        var json = await Konva.InvokeAsync<string>("saveAsJson");

        if (!json.Equals(DrawingAsJson))
        {
            await OnDrawingChanged.InvokeAsync(json);
        }



    }



    private async Task NewDrawing()
    {
        await Konva.InvokeVoidAsync("newDrawing");
    }

    private async Task SetField(string field)
    {
        await Konva.InvokeVoidAsync("setField", field);
    }

    private async Task DeleteSelectedShapes()
    {
        await Konva.InvokeVoidAsync("deleteSelectedShapes");
    }

    private async Task LoadJson()
    {
        await Konva.InvokeVoidAsync("loadDrawing", DrawingAsJson);
    }

}
