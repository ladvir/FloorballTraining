@using Microsoft.AspNetCore.Components
@using MudBlazor.Utilities

@inject IJSRuntime JsRuntime

<MudPaper Elevation="0" Class="ma-0 pa-0" >

    <MudPaper Elevation="0" Class="d-inline-block gap-2">
        <MudIconButton Color="Color.Success" Title="Uložit" Icon="@Icons.Material.Sharp.Save" OnClick="SaveDrawing" />
        <MudIconButton id="newdrawing" Color="Color.Secondary" Title="Nový" Icon="@Icons.Material.Sharp.Create" OnClick="NewDrawing" />
    </MudPaper>

    @*Fields*@
    <MudPaper Elevation="0" Class="d-inline-flex align-content-start justify-content-start">
        @foreach (var field in Assets.Fields)
        {
            <MudButton OnClick="@(()=>SetField(field.Value))">
                    <MudImage ObjectFit="ObjectFit.Fill" Width="64" Height="64" Src="@field.Value" Elevation="0" Class="rounded" />
            </MudButton>
        }
    </MudPaper>

    

    
    
        

        @*Drawings*@
        <MudPaper Elevation="0" Class="d-inline-flex align-content-start justify-content-start">
            @foreach (var drawing in Assets.Drawings)
            {
                <MudButton OnClick="@(()=>SetTool(drawing.Key))">
                    <MudImage ObjectFit="ObjectFit.Fill" Width="64" Height="64" Src="@drawing.Value" Elevation="0" Class="rounded" />
                </MudButton>
            }
        </MudPaper>
       
        



            <MudColorPicker id="colorpicker" Style="@ColorPickerStyle" ColorPickerView="ColorPickerView.Palette" Label="Barva" @bind-value="@_colorValue" />
       
        <MudPaper Elevation="0" Class="d-inline-block gap-2">
            <MudIconButton id="@Assets.ToolDelete" CheckedIcon="@Icons.Material.Sharp.Delete" Icon="@Icons.Material.Sharp.Delete" Color="Color.Info" OnClick="@(DeleteSelectedShapes)">Smazat</MudIconButton>
        </MudPaper>
    
    <MudPaper id="container" Class="ma-0 pa-0 d-block" Style="width: 100%; height: 80vh;"></MudPaper>
</MudPaper>

@code {
    

    private string _tool = string.Empty;

    private MudColor _colorValue =null!;

    private string ColorPickerStyle => $"width:140px;color: {_colorValue};";

    private IJSObjectReference Konva { get; set; } = null!;


    private string _buttonStyle = "background-color:white;";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Konva = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./DrawingTool.js");
            await Konva.InvokeVoidAsync("init", "container"); // "container" je ID divu pro umístění plátna Konva.js
        }
    }
}


@code {

    private async Task SetTool(string toolId)
    {
        _tool = _tool == toolId ? string.Empty : toolId;
        await Konva.InvokeVoidAsync("setTool", _tool);
    }

    private async Task SaveDrawing()
    {
        await Konva.InvokeVoidAsync("saveDrawing");
    }

    private async Task NewDrawing()
    {
        await Konva.InvokeVoidAsync("newDrawing");
    }

    private async Task SetField(string field)
    {
        await Konva.InvokeVoidAsync("setField", field);
    }

    private async Task DeleteSelectedShapes()
    {
        await Konva.InvokeVoidAsync("deleteSelectedShapes");
    }

}
