@inject IAddActivityUseCase AddActivityUseCase

<MudText Typo="Typo.h4">Nová aktivita</MudText>


<EditForm Model="@_activity" OnValidSubmit="Submit">
    <FluentValidationValidator />
    <ValidationSummary />
    <MudPaper Elevation="0" Class="d-flex flex-wrap">
        @*Field*@
        <MudPaper Elevation="0">

            <MudTextField Label="Název" @bind-Value="_activity.Name" For="() => _activity.Name" />
            <MudTextField Label="Popis" For="()=>_activity.Description" @bind-Value="_activity.Description" Lines="6" Variant="Variant.Outlined" Margin="Margin.Dense" Class="my-5" />

            <MudPaper Elevation="0" Class="d-inline-flex gap-4">
                <MudPaper Elevation="0">
                    <MudText>Počet osob: @Persons</MudText>
                    <RangeSlider @bind-ValueHigh="@_activity.PersonsMax" @bind-ValueLow="@_activity.PersonsMin" MinValue="1" MaxValue="50" />
                </MudPaper>

                <MudPaper Elevation="0">
                    <MudText>Doba trvání: @Duration</MudText>
                    <RangeSlider @bind-ValueHigh="@_activity.DurationMax" @bind-ValueLow="@_activity.DurationMin" MaxValue="180" MinValue="1" />
                </MudPaper>
            </MudPaper>

            <MudPaper Elevation="0" Class="my-2">
                <MudText>Vybavení</MudText>
                <MudPaper Class="d-flex flex-wrap my-2" MaxWidth="50vw" Width="50vw" Elevation="0">
                    <ActivityEquipmentsComponent SelectedValues="@_activity.ActivityEquipments.Select(ae=>ae.Equipment).ToList()" SelectedValuesChanged="SelectedEquipmentsChanged"/>
                </MudPaper>
            </MudPaper>


            <MudPaper Elevation="0" Class="my-2">
                <MudText>Štítky</MudText>
                <MudPaper Class="d-flex flex-wrap my-2" MaxWidth="50vw" Width="50vw" Elevation="0">

                    <ActivityTagComponent Activity="_activity" OnSelectedTagsChanged="SelectedTagsChanged" />
                </MudPaper>
            </MudPaper>
        </MudPaper>
        @*Tags *@
        <MudPaper Elevation="0" Class="align-stretch flex-grow-0 my-0">
            <MudPaper Class="d-flex align-right justify-top pa-3 " Style="height: 60vh; overflow-y: auto;" Elevation="0">
                <TagTreeComponent SelectedTags="@_activity.ActivityTags.Select(at=>at.Tag).ToList()" OnSelectedTagsChanged="SelectedTagsChanged"/>
            </MudPaper>
        </MudPaper>
    </MudPaper>

    @*Buttons*@
    <MudPaper Elevation="0" Class="d-inline-flex my-2">
        <MudButton ButtonType="ButtonType.Button" Variant="Variant.Filled" Color="Color.Primary" OnClick="Cancel">Cancel</MudButton>
        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" @onkeypress:preventDefault>OK</MudButton>
    </MudPaper>
</EditForm>


@code {
    private readonly Activity _activity = new();

    private string Persons => StringExtensions.GetRangeString(_activity.PersonsMin, _activity.PersonsMax);
    private string Duration => StringExtensions.GetRangeString(_activity.DurationMin, _activity.DurationMax);

    [Parameter]
    public EventCallback OnFormClosed { get; set; }

    [Parameter]
    public EventCallback<Activity> OnActivityAdded { get; set; }


    private async Task Submit()
    {
        await AddActivityUseCase.ExecuteAsync(_activity);
        await OnActivityAdded.InvokeAsync(_activity);
    }

    private void Cancel()
    {
        OnFormClosed.InvokeAsync();
    }
    private void SelectedTagsChanged(Activity a)
    {
        StateHasChanged();
    }

    private void SelectedTagsChanged(List<Tag> tags)
    {
        _activity.ActivityTags = new List<ActivityTag>();
        foreach (var tag in tags)
        {
            _activity.AddTag(tag);
        }

        StateHasChanged();
    }


    private void SelectedEquipmentsChanged(IEnumerable<Equipment> equipments)
    {
        
            _activity.ActivityEquipments = new List<ActivityEquipment>();


            foreach (var equipment in equipments)
            {
                _activity.AddEquipment(equipment);
            }


            StateHasChanged();
        

    }

}
