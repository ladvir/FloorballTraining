@using FloorballTraining.WebApp.Pages.Activities
@using FloorballTraining.WebApp.Data
@inject IDialogService DialogService
<MudPaper Class="d-inline-flex flex-grow-1 gap-2  " Elevation="0" Width="100%">

    @foreach (var trainingGroup in TrainingGroups)
    {
        var duration = trainingGroup.TrainingGroupActivities.Sum(tg => tg.Duration);
        <MudPaper Elevation="0" Class="flex-shrink-1 flex-grow-1 my-4">

            <MudField Label="@($"Skupina - {trainingGroup.TrainingGroupId}")" Class="ma-2" Variant="Variant.Outlined">
                <MudTextField Label="Název" @bind-Value="trainingGroup.Name" FullWidth="true" />

                <MudPaper Elevation="0" Class="d-inline-flex gap-2">
                    <MudText>Počet osob: @trainingGroup.PersonsMax</MudText>
                    <MudSlider T="int" @bind-Value="@trainingGroup.PersonsMax" Min="1" Max="PersonsMax" Size="Size.Medium" Style="Width: inherit;" />
                </MudPaper>

                <MudToolBar Dense="true" Class="ma-0 pa-0">
                    <MudChip Icon="@Icons.Material.Filled.Add" Variant="Variant.Outlined" Color="Color.Success" OnClick="() => AddActivity(trainingGroup, PersonsMax)">Vybrat aktivity</MudChip>
                    <MudSpacer />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="() => TrainingGroups.Remove(trainingGroup)" />
                </MudToolBar>

                <MudPaper Elevation="0">
                    <MudText>Doba trvání: @duration</MudText>
                </MudPaper>

                <MudPaper Class="" Elevation="0">
                    @foreach (var activity in trainingGroup.TrainingGroupActivities)
                    {
                        var maxDuration = activity.Activity?.DurationMax ?? DurationMax;
                        <MudPaper Elevation="0" MinWidth="20vh" Width="100%">
                            <MudPaper Class="d-inline-flex gap-2 py-0 px-2" >
                                <MudText Typo="Typo.h6">@activity.Activity?.Name</MudText>

                                <MudPaper Class="d-inline-flex gap-1 px-2" Elevation="0">
                                    <Slider MinValue="1" MaxValue="@maxDuration" Value="@activity.Duration" ValueChanged="@((e)=>OnActivityDurationChanged(activity, e))" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Info" Color="Color.Default" OnClick="@(() => ShowActivityDetail(activity.Activity))" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Default" OnClick="() => RemoveActivity(trainingGroup, activity)" />
                                </MudPaper>
                            </MudPaper>
                        </MudPaper>
                    }
                </MudPaper>
            </MudField>
        </MudPaper>
    }

</MudPaper>




@code {
    [Parameter]
    public List<TrainingGroup> TrainingGroups { get; set; } = new List<TrainingGroup>();

    [Parameter]
    public int DurationMax { get; set; }

    [Parameter]
    public int PersonsMin { get; set; }

    [Parameter]
    public int PersonsMax { get; set; }

    [Parameter]
    public EventCallback OnActivityAdded { get; set; }

    [Parameter]
    public EventCallback OnActivityRemoved { get; set; }

    [Parameter]
    public EventCallback OnDurationChanged { get; set; }

    private async Task AddActivity(TrainingGroup trainingGroup, int personsMax)
    {
        var options = new DialogOptions
            {
                NoHeader = false,
                CloseOnEscapeKey = true,
                CloseButton = true,
                DisableBackdropClick = true,
                Position = DialogPosition.Center,
                MaxWidth = MaxWidth.ExtraLarge,
                FullWidth = true,
                FullScreen = false
            };

        var activitySearchCriteria = new ActivitySearchCriteria()
        {
            DurationMax = DurationMax,
            PersonsMin = PersonsMin,
            PersonsMax = personsMax

        };

        var parameters = new DialogParameters { ["ActivitySearchCriteria"] = activitySearchCriteria };

        var dialog = await DialogService.ShowAsync<ActivityListModal>("Výběr aktivit",parameters, options);

        var result = await dialog.Result;

        if (result == DialogResult.Cancel())
        {
            return;
        }


        if (result.Data == null) return;

        var activities = (List<Activity>)result.Data;

        foreach (var activity in activities)
        {


            trainingGroup.TrainingGroupActivities.Add(new TrainingGroupActivity
                {
                    Activity = activity,
                    ActivityId = activity.ActivityId,
                    TrainingGroup = trainingGroup,
                    TrainingGroupId = trainingGroup.TrainingGroupId,
                    Duration = activity.DurationMax

                });
        }

        await OnActivityAdded.InvokeAsync();
    }

    private void ShowActivityDetail(Activity? activityActivity)
    {
        throw new NotImplementedException();
    }

    private void RemoveActivity(TrainingGroup trainingGroup, TrainingGroupActivity activity)
    {
        trainingGroup.TrainingGroupActivities.Remove(activity);
        OnActivityRemoved.InvokeAsync();
    }

    private void OnActivityDurationChanged(TrainingGroupActivity activity, int value)
    {
        activity.Duration = value;
        OnDurationChanged.InvokeAsync();
    }

}
