@using FloorballTraining.UseCases.AgeGroups
@inject IViewAgeGroupByNameUseCase ViewAgeGroupByNameUseCase

<MudPaper Elevation="0" Class="d-inline-flex flex-wrap my-2 align-items-start">
    @foreach (var possibleValue in _ageGroups)
    {
        <MudCheckBox T="bool" Color="Color.Success" Class="mr-4 d-inline-flex flex-wrap" ReadOnly="@(ReadOnly || possibleValue.IsKdokoliv() && IsChecked(possibleValue.AgeGroupId))" Size="Size.Small" Style="vertical-align: middle;"
                     Dense="true" Checked="@IsChecked(possibleValue.AgeGroupId)" CheckedChanged="@((isChecked) => CheckboxChanged(isChecked, possibleValue))"> @possibleValue.Description
            
    </MudCheckBox>
    }
</MudPaper>


@code {
    [Parameter]
    public IEnumerable<AgeGroup?>? SelectedValues { get; set; } 

    [Parameter]
    public EventCallback<List<AgeGroup>> SelectedValuesChanged { get; set; }

    [Parameter]
    public bool ReadOnly { get; set; }

    private IEnumerable<AgeGroup> _ageGroups = new List<AgeGroup>();

    private List<AgeGroup> _selectedValues = new();

    protected override async Task OnInitializedAsync()
    {
        if(SelectedValues!=null)
        {
            foreach (var item in SelectedValues.Where(s=>s!=null))
            {
                _selectedValues.Add(item!);
            }
        } 

        _ageGroups = await ViewAgeGroupByNameUseCase.ExecuteAsync();

        if (!_selectedValues.Any())
        {
            var firstKdokoliv = _ageGroups.FirstOrDefault(ag => ag.IsKdokoliv());

            if (firstKdokoliv != null)
            {
                _selectedValues.Add(firstKdokoliv);
                await SelectedValuesChanged.InvokeAsync(_selectedValues);
            }
        }
        

    }

    private bool IsChecked(long ageGroupId)
    {
        return _selectedValues.Exists(s => s.AgeGroupId == ageGroupId);
    }

    private async Task CheckboxChanged(bool isChecked, AgeGroup value)
    {

        var cats = _ageGroups.Where(ag => !ag.IsKdokoliv()).ToList();

        var isKdokolivChecked = SelectedValues != null && SelectedValues.Any(sv=>sv != null && sv.IsKdokoliv());

        if (isChecked)
        {
            if (isKdokolivChecked) {
                _selectedValues.Clear();
            }
            var i = _ageGroups.First(s => s.AgeGroupId == value.AgeGroupId);
            _selectedValues.Add(i);

            var selectedAll = cats.All(s => _selectedValues.Exists(c => c == s));

            if (selectedAll || value.IsKdokoliv())
            {
                _selectedValues.Clear();

                var kdokoliv = _ageGroups.First(ag => ag.IsKdokoliv());
                _selectedValues.Add(kdokoliv);
            }

        }
        else
        {
            if (value.IsKdokoliv())
            {
                _selectedValues.Clear();
            }
            else
            {
                var i = _selectedValues.First(s => s.AgeGroupId == value.AgeGroupId);
                _selectedValues.Remove(i);
            }
        }

        await SelectedValuesChanged.InvokeAsync(_selectedValues);
    }
}





    

