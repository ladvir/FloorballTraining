@page "/activities"
@using FloorballTraining.UseCases.Activities.Interfaces
@using FloorballTraining.CoreBusiness.Specifications
@using FloorballTraining.CoreBusiness.Dtos
@inject AppSettings AppSettings
@inject IViewActivitiesUseCase ViewActivitiesUseCase

<MudText Typo="Typo.h4">Aktivity</MudText>
<SearchActivityComponent SearchCriteria="@_searchCriteria" DurationMax="AppSettings.MaxActivityDuration" PersonsMax="@AppSettings.MaximalPersons" OnSearchItem="Search" OnActivityAdded="AddActivityIntoListOfActivities" />
<br/>

@if(_activities==null)
{
    <MudPaper Class="align-center justify-center mud-width-full" Elevation="0">
        <MudProgressCircular Color="Color.Warning" Size="Size.Large" Indeterminate="true" />
    </MudPaper>   
}else {
    <SendActivityViaEmailComponent ActivityIds="@_selectedActivityIds" />
    <ActivityListComponent Activities="@_activities" SelectedActivitiesChanged="OnSelectedActivitiesChanged" />
}

@code {
    SearchCriteria _searchCriteria = new ();
    List<ActivityDto>? _activities ;
    List<int> _selectedActivityIds = new();

    protected override async Task OnInitializedAsync()
    {
        await SearchByCriteria(_searchCriteria);
    }

    private async Task Search(SearchCriteria searchCriteria)
    {
        _searchCriteria = searchCriteria;
        await SearchByCriteria(_searchCriteria);
    }

    private async Task SearchByCriteria(SearchCriteria searchCriteria)
    {
        var parameters = new ActivitySpecificationParameters()
        {
            Id = searchCriteria.Ids.FirstOrDefault(),
            Name = searchCriteria.Text,
            Description = searchCriteria.Text,
            Tag = string.Join(";", searchCriteria.Tags)
        };

        var result = await ViewActivitiesUseCase.ExecuteAsync(parameters);
        _activities = result.Data.ToList();
    }

    private void AddActivityIntoListOfActivities(ActivityDto activity)
    {
        _activities?.Add(activity);
    }

    private void OnSelectedActivitiesChanged(List<int> selectedActivityIds)
    {
        _selectedActivityIds = selectedActivityIds;
        StateHasChanged();
    }

}
